<!DOCTYPE html>
<html lang="en">
<head>
    <title>A Notes App</title>
    <link rel="stylesheet" type="text/css" href="/style.css">
  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.8.34/browser.min.js"></script>
    <script type="text/babel">
        const parseJSON=(xhr,content,viewForm)=>{
            if(xhr.response&&xhr.getResponseHeader('Content-Type')==='application/json'){
                const obj=JSON.parse(xhr.response);
                console.dir(obj);
                
                if(obj.message){
                    content.innerHTML+=`<p>Message: ${obj.message}</p>`;
                    if(obj.titles&&!(obj.titles.length===0)){
                        for(let i=0;i<obj.titles.length;i++){
                            let option=document.createElement('option');
                            option.value=`${noteFormTitleField.value}`;
                            option.text=`${noteFormTitleField.value}`;
                            document.getElementById('noteSelect').appendChild(option);
                        }
                    }
                } else if(obj.title&&obj.content){
                    viewForm.querySelector('#titleField').value=obj.title;
                    viewForm.querySelector('#noteField').value=obj.content;
                } 
            }
        };
        
        const handleResponse = (xhr, parseResponse, loggedIn) => {
            const content = document.querySelector('#content');
            const viewForm=document.querySelector('#viewForm');
            const retrieveForm=document.querySelector('#retrieveForm');
            
            switch(xhr.status){
                case 200:
                    if(loggedIn) content.innerHTML='<b>Your note was successfully retrieved!</b>';
                    else{
                        content.innerHTML='<b>You have successfully logged in to your account!</b>';
                        document.getElementById('login').style.visibility="hidden";
                        document.getElementById('create').style.visibility="visible";
                        document.getElementById('retrieve').style.visibility="visible";
                    }
                    break;
                case 201:
                    if(loggedIn) content.innerHTML='<b>Your note was successfully created!</b>';
                    else{
                        content.innerHTML='<b>You have successfully created your account!</b>';
                        document.getElementById('login').style.visibility="hidden";
                        document.getElementById('create').style.visibility="visible";
                    }
                    break;
                case 204:
                    content.innerHTML='<b>Your note was successfully updated!</b>';
                    break;
                case 400:
                    content.innerHTML='<b>Error 400: Bad Request</b>';
                    break;
                case 401:
                    if(loggedIn){
                        content.innerHTML='<b>Error 401: Unauthorized</b>';
                        document.getElementById('login').style.visibility="visible";
                        document.getElementById('create').style.visibility="hidden";
                        document.getElementById('retrieve').style.visibility="hidden";
                        document.getElementById('view').style.visibility="hidden";
                        document.getElementById('userField').value='';
                        document.getElementById('passField').value='';
                    } else {
                        content.innerHTML='<b>Error 401: Unauthorized</b>';
                        document.getElementById('userField').value='';
                        document.getElementById('passField').value='';
                    }
                    break;
                case 404:
                    content.innerHTML='<b>Error 404: Resource Not Found</b>';
                    break;
                default:
                    content.innerHTML='<b>Error: Status Code not Implemented</b>';
                    break;
            }
            
            if(parseResponse)parseJSON(xhr,content,viewForm);   
        };

        const requestUpdate = (e, form) => {
            let url = retrieveForm.getAttribute('action');
            const method = retrieveForm.getAttribute('method');
                
            const select = retrieveForm.querySelector('select');
            let user=document.querySelector('#userField').value;
            url+=`?user=${user}&title=${select.options[select.selectedIndex].value}`;
   
            
            const xhr = new XMLHttpRequest();
            xhr.open(method, url);
            
            xhr.setRequestHeader('Accept', 'application/json');
            
            if(method==='get'){
                xhr.onload=()=>handleResponse(xhr, true, true);
            } else {
                xhr.onload=()=>handleResponse(xhr, false, true);
            }
            
            xhr.send();
            
            e.preventDefault();
            return false;
        };

        const sendPost=(e,form)=>{
            //we want to prevent the page from sending on its own
            e.preventDefault();
            
            const action=form.getAttribute('action');
            const method=form.getAttribute('method');
            let formData='';
            let loggedIn=false;
            
            if(action==='/logIn'){
                const user=form.querySelector('text');
                const pass=form.querySelector('pass');
                formData=`user=${user}&pass=${pass}`;
            }
            
            else if(action==='/addNote'){
                loggedIn=true;
                const user=document.querySelector('#userField').value;
                const titleField=form.querySelector('#titleField');
                const contentField=form.querySelector('#noteField');
                formData=`user=${user}&title=${titleField.value}&content=${noteField.value}`;
            }
            
            const xhr=new XMLHttpRequest();
            xhr.open(method, action);
            
            xhr.setRequestHeader('Accept', 'application/json');
            xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
            
            xhr.onload=()=>handleResponse(xhr,true, loggedIn);
            
            
            xhr.send(formData);
            
            return false;
        };

        const init = () => {
            const loginForm=document.querySelector('#loginForm');
            const noteForm=document.querySelector('#noteForm');
            const retrieveForm=document.querySelector('#retrieveForm');
            const viewForm=document.querySelector('#viewForm');
            
            document.getElementById('create').style.visibility="hidden";
            document.getElementById('retrieve').style.visibility="hidden";
            document.getElementById('view').style.visibility="hidden";
            
            const logIn=(e)=>sendPost(e,loginForm);
            
            const newNote=(e)=>{
                sendPost(e,noteForm);
                document.getElementById('view').style.visibility="visible";
                
                const viewFormNoteField=viewForm.querySelector('#noteField');
                const noteFormNoteField=noteForm.querySelector('#noteField');
                const viewFormTitleField=viewForm.querySelector('#titleField');
                const noteFormTitleField=noteForm.querySelector('#titleField');
                
                viewFormNoteField.value=noteFormNoteField.value;
                viewFormTitleField.value=noteFormTitleField.value;
                let option=document.createElement('option');
                option.value=`${noteFormTitleField.value}`;
                option.text=`${noteFormTitleField.value}`;
                document.getElementById('noteSelect').appendChild(option);
                noteFormNoteField.value='';
                noteFormTitleField.value='';
            };
            
            const getNote=(e)=>requestUpdate(e,retrieveForm);
            
            const editNote=(e)=>sendPost(e,viewForm);
            
            noteForm.addEventListener('submit', newNote);
            retrieveForm.addEventListener('submit', getNote);
            viewForm.addEventListener('submit',editNote);
        };

        window.onload = init;
    </script>
</head>
<body>
    <div id="top">
        <h1>Notekeeper</h1>
        <h3>A place to keep some notes.</h3>
    </div>
    <div id="main">
        <section id="content"></section>
        <div id="login">
            <h3>Please Log In!</h3>
            <p>If you haven't logged in before, logging in will create a new account.</p>
            <p>Please make sure to use a password that you don't use elsewhere!</p>
            <form id="loginForm" action="/logIn" method="post">
                <label for="username">Username:</label>
                <input id="userField" type="text" name="username"/>
                <label for="password">Password:</label>
                <input id="passField" name="password" type='password'/>
                <input type="submit" value="login" />
            </form>
        </div>
        <div id="create">
            <h3>Make a New Note!</h3>
            <p>(We don't recommend putting super important, secret, personal data in these notes right now.)</p>
            <form id="noteForm" action="/addNote" method="post">
                <label for="title">Give it a Title!</label>
                <input id="titleField" type="text" name="title"/>
                <label for="noteField">Write a Note!</label>
                <textarea id="noteField" name="noteField" wrap="soft" placeholder="Write your note here." rows="10" cols="50"></textarea>
                <input type="submit" value="Save Note" />
            </form>
        </div>
        
        <div id="retrieve">
            <h3>Retrieve a Note!</h3>
            <form id="retrieveForm" action="/getNote" method="get">
                <label for="name">Note Name?</label>
                <select id="noteSelect" name="name"></select>
                <input type="submit" value="Retrieve Note" />
            </form>
        </div>
        
        <div id="view">
            <h3>View or Edit a Note!</h3>
            <form id="viewForm" action="/addNote" method="post">
                <input id="titleField" type="text" readonly/>
                <textarea id="noteField" name="noteField" wrap="soft" rows="10" cols="50">There's no note here!</textarea>
                <input type="submit" value="Save Changes" />
            </form>
        </div>
        
    </div>
    <footer>Made by J. Hernandez</footer>
</body>
</html>